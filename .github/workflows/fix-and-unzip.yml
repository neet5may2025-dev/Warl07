name: Fix and Unzip Expo project

on:
  workflow_dispatch:

jobs:
  fix-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Find first zip in repo root
        id: findzip
        run: |
          set -e
          ZIP=$(ls *.zip 2>/dev/null | head -n1 || true)
          if [ -z "$ZIP" ]; then
            echo "no_zip=true" >> $GITHUB_OUTPUT
            echo "::warning::No zip file found in repo root. Commit the zip file first."
            exit 0
          fi
          echo "zipfile=$ZIP" >> $GITHUB_OUTPUT

      - name: Create workdir and unzip
        if: steps.findzip.outputs.zipfile != ''
        run: |
          mkdir -p extract
          unzip -q "${{ steps.findzip.outputs.zipfile }}" -d extract

      - name: Convert .js.txt and .json.txt to real files
        if: steps.findzip.outputs.zipfile != ''
        run: |
          shopt -s globstar || true
          # js.txt
          for f in extract/**/**/*.js.txt extract/**/*.js.txt; do
            [ -f "$f" ] || continue
            mv "$f" "${f%.txt}"
          done
          # json.txt
          for f in extract/**/**/*.json.txt extract/**/*.json.txt; do
            [ -f "$f" ] || continue
            mv "$f" "${f%.txt}"
          done

      - name: Fix directory names with colons (replace ":" with "/")
        if: steps.findzip.outputs.zipfile != ''
        run: |
          # find directories with colons and move them to a path with slashes
          find extract -depth -type d -name "*:*" | while IFS= read -r d; do
            new=$(echo "$d" | sed 's/:/\//g' )
            mkdir -p "$(dirname "$new")"
            mv "$d" "$new" || true
          done || true

      - name: Normalize icon filename to assets/icon.png if present
        if: steps.findzip.outputs.zipfile != ''
        run: |
          if [ -d extract/assets ]; then
            for f in extract/assets/*icon*.png extract/assets/*icon*.PNG; do
              [ -f "$f" ] || continue
              mv -f "$f" extract/assets/icon.png
              break
            done
          fi

      - name: Add app.json if missing
        if: steps.findzip.outputs.zipfile != ''
        run: |
          if [ ! -f extract/app.json ]; then
            cat > extract/app.json <<'JSON'
{
  "expo": {
    "name": "StudyMother",
    "slug": "studymother",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "android": {
      "package": "com.studymother.app"
    },
    "assetBundlePatterns": ["**/*"]
  }
}
JSON
          fi

      - name: Move extracted files to repo root
        if: steps.findzip.outputs.zipfile != ''
        run: |
          # Copy everything from extract/* to repo root, overwriting where necessary
          cp -a extract/. .

      - name: Commit and push fixes
        if: steps.findzip.outputs.zipfile != ''
        run: |
          git config user.name "github-actions[bot]" || true
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com" || true
          git add -A
          git commit -m "ci: automated unzip & fix (convert .txt -> .js/.json, fix folders, add app.json)" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed"
